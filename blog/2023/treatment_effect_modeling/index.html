<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Decision Making Needs Modeling Intervention Effects | Andro Sabashvili</title> <meta name="author" content="Andro Sabashvili"> <meta name="description" content="Review of treatment effect estimation techniques"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/japanh.jpg?5b76209d3d83dda5bfb5bfafd53ee8e1"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://androsaba.github.io/blog/2023/treatment_effect_modeling/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> <style type="text/css">.footnote{font-size:80%}</style> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Decision Making Needs Modeling Intervention Effects",
      "description": "Review of treatment effect estimation techniques",
      "published": "November 29, 2023",
      "authors": [
        {
          "author": "Andro Sabashvili",
          "authorURL": "",
          "affiliations": [
            {
              "name": "Myself", 
               "url": ""
            }
                    ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span style="font-weight: bold; color: white;">Andro </span>Sabashvili</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/about/">ABOUT</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="post distill"> <d-title> <h1>Decision Making Needs Modeling Intervention Effects</h1> <p>Review of treatment effect estimation techniques</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#problem-with-ml">Problem with ML</a></div> <div><a href="#definitions">Definitions</a></div> <div><a href="#algorithms-for-treatment-effect-estimation">Algorithms for Treatment Effect Estimation</a></div> <div><a href="#"></a></div> <ul> <li><a href="#difference-in-differences-did">Difference in Differences (DiD)</a></li> <li><a href="#synthetic-control">Synthetic Control</a></li> <li><a href="#2-model-approach">2-Model Approach</a></li> <li><a href="#target-transformation-approach">Target Transformation Approach</a></li> <li><a href="#"></a></li> </ul> <div><a href="#summary">Summary</a></div> </nav> </d-contents> <h2 id="problem-with-ml">Problem with ML</h2> <p>Predictive machine learning models are built to improve decision making process. Usually they are embedded in complex decision logic. There are many processes that are intervened by us based on the predictions our ML model makes. For instance, consider churn prevention problem.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/treatment_effect_estimation/churn.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>We build a churn prediction model, then we score the entire customer base, customers with the highest churn scores are identified and customer experience team sends them relevant offers retain them. After receiving offers some of them do not churn but some leave anyway. Few months later the churn model needs to be retrained on the new sample where persuadable customers (the ones that were contacted and stayed) are labeled as 0, while the lost ones (the ones that were contacted but left) are labeled as 1. Therefore former gets low score whereas the latter gets high score. So the new model learns to stop calling persuadable customers and keep calling lost customers. None of them is a decision we want to make. What this use case teaches us is that</p> <div style="background-color: rgba(0, 0, 0, 0.0470588); text-align: center; vertical-align: middle; padding: 20px 0; margin: 0px 0 20px;"> <strong>ignoring interventions leads to wrong decisions.</strong> </div> <p>One should estimate the intervention effect or, in this case, probability of churn given intervention instead of simply retraining the model.</p> <p>In the following we review algorithms for modeling intervention (treatment) effects. But before that let’s talk about another problem of ML which is <em>“causation is not the same as correlation”</em>. Let’s demonstrate this in case of two very basic causal DAGs, Fork and Collider.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/treatment_effect_estimation/dags.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Fork describes a process when a a single variable <strong>Z</strong> is affecting both <strong>X</strong> and <strong>Y</strong> and therefore they appear correlated even though there is is no causal link between them.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/treatment_effect_estimation/fork.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The spurious correlation is gone only after conditioning both of them on <strong>Z</strong>.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/treatment_effect_estimation/fork_conditioned.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>In Collider <strong>X</strong> and <strong>Y</strong> are not causally linked but they both affect <strong>Z</strong>. One doesn’t observe any correlation between <strong>X</strong> and <strong>Y</strong>, as it should be.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/treatment_effect_estimation/collider.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>But conditioning them on <strong>Z</strong> leads to a large $R^2$.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/treatment_effect_estimation/collider_conditioned.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Therefore, ignoring causal links can also lead us to wrong decisions as they would be based on the spurious correlations.</p> <h2 id="definitions">Definitions</h2> <p>Estimating a treatment effect implies answering what if… question or, in technical terms, estimating the corresponding counterfactual. Counterfactual refers to the value of the parameter of interest if intervention had not occur. So in the case of the churn use case, that would be the scenario when we never communicate with the customers. Another important concept is the treatment effect, which is the difference between the value of the parameter for the treated unit and the value the parameter for the treated unit would have had if we had not applied any treatment, Eq. 1.</p> <p>\begin{equation} TE = Y_T(t=1;W=1)-Y_T(t=1;W=0) \end{equation}</p> <p><strong>Y</strong> is the variable of interest where <strong>T</strong> stands for treatment group, <strong>t</strong> is a binary variable indicating whether it is measured in pre ($t=0$)- or post-intervention ($t=1$) period and <strong>W</strong> is also binary telling us whether treatment is applied or not. So by definition the second term in Eq.1 is counterfactual. Usually we want to calculate conditional average treatment effect given in Eq. 2.</p> <p>\begin{equation} CATE = E[Y_T(t=1;W=1)-Y_T(t=1;W=0)|X] \end{equation}</p> <p>Another term for the treatment effect coming from the marketing literature is uplift. It is used in the context of the interventions applied to a customer base.</p> <h2 id="algorithms-for-treatment-effect-estimation">Algorithms for Treatment Effect Estimation</h2> <h3 id="difference-in-differences-did">Difference in Differences (DiD)</h3> <p>So basically problem of treatment effect reduces to the counterfactual estimation because the first term in Eq. 2 is observed. There are two naive approximations for the counterfactual. The first one is to replace it with the value of $Y_T$ before the intervention.</p> \[CATE = E[Y_T(t=1;W=1)-Y_T(t=0;W=0)|X]\] <p>But this is not a good approximation because it assumes that there is no trend or seasonality in the time series and it changes only due the intervention. The second approximation is to utilize the control group in the post intervention period.</p> \[CATE = E[Y_T(t=1;W=1)-Y_C(t=1;W=0)|X]\] <p>But this approximation assumes that the control group is very similar to the treatment group in the pre-intervention period and would have remained similar if no treatment had been applied. That is also a strong assumption. Usually what’s used in practice is the combination of these two approximations resulting in the <strong>DiD</strong> estimator. So, counterfactual term is approximated with</p> \[\begin{align*} E[Y_T(t=1;W=0)|X]=&amp;E[Y_T(t=0;W=0)|X]+\\ &amp;+(E[Y_C(t=1;W=0)|X]-E[Y_C(t=0;W=0)|X]). \end{align*}\] <p>Plugging it into the equation of <strong>CATE</strong> yields</p> \[\begin{align*} CATE = &amp;(E[Y_T(t=1;W=1)|X] - E[Y_T(t=0;W=0)|X])-\\ &amp;-(E[Y_C(t=1;W=0)|X]-E[Y_C(t=0;W=0)|X]). \end{align*}\] <p>The first term is the difference between $Y_T$ values before and after intervention which is the treatment effect plus the change that would have occurred anyway. To cancel out the latter component the second term is subtracted which is a difference between $Y_C$ values before and after intervention. In other words we assume that the natural change that would have occurred in the treatment group is the same as in the control group. What if treatment and control time series have different scales? If this is the case let’s approximate the counterfactual using</p> \[\begin{align*} E[Y_T(t=1;W=0)|X]=E[Y_T(t=0;W=0)|X]\cdot \frac{E[Y_C(t=1;W=0)|X]}{E[Y_C(t=0;W=0)|X]} \end{align*}\] <p>resulting in</p> \[\begin{align*} CATE &amp;= (E[Y_T(t=1;W=1)|X] - E[Y_T(t=0;W=0)|X])-\\ &amp;-\frac{E[Y_T(t=0;W=0|X)]}{E[Y_C(t=0;W=0|X)]}\cdot(E[Y_C(t=1;W=0)|X]-E[Y_C(t=0;W=0)|X]) \end{align*}\] <p>more general expression in a sense that it reduces to the previous formula if the expectation of the treatment and control group values before the intervention are equal. Hence, to resolve issue of having different scales in the treatment and control time series ratio between pre- and post-intervention control group values is used instead of the absolute difference.</p> <h3 id="synthetic-control-brodersen-et-al-annals-of-applied-statistics-2015">Synthetic Control <d-footnote>Brodersen et al., Annals of Applied Statistics (2015)</d-footnote> </h3> <p><strong>DiD</strong> requires treatment and control time series to have parallel trends and, in general, to be similar. This is quite strong requirement which is dropped by the synthetic control approach. Instead of finding a control time series very similar to the treated one let’s train a model on the bunch of untreated time series with output variable being the treated time series before the intervention. If the trained model has a good performance and accurately predicts the treated time series it can serve us as the control group. The model predictions in the post-intervention period represents counterfactual estimations. This is a very trivial but powerful idea. We don’t have to find time series similar to the treatment group, the only requirement is that the intervention does not affect them and they need to be predictive of the treatment time series.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/treatment_effect_estimation/synthetic_control.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Fig 1. Synthetic control method </div> <p>Fig. 1 depicts this idea. $Y$ is the treated time series while $X_1$ and $X_2$ are input to the model that tries to predict $Y$. The dashed vertical line denotes the intervention. The solid blue is the fitted line whereas dashed blue line represents forecasts after the intervention. Therefore <strong>CATE</strong> would be the difference between solid black and dashed blue lines.</p> <h3 id="2-model-approach-s-athey-and-g-w-imbens-machine-learning-methods-for-estimating-heterogeneous-causal-effects-stat-10505-2015b">2-Model Approach <d-footnote>S. Athey and G. W. Imbens, Machine learning methods for estimating heterogeneous causal effects, stat, 1050:5, 2015b.</d-footnote> </h3> <p>Another way of estimating <strong>CATE</strong> is to train two models on the treatment and the control group samples, respectively. Their predictions are estimates of the two terms in the definition of <strong>CATE</strong> in Eq. 2. This method can be reduced to the 1-model approach by combining treatment and control samples and adding <strong>W</strong>=(0,1) to the combined sample as one of the features.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/treatment_effect_estimation/2_model_approach.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Fig 2. Left: 2-model approach, Right: 1-model approach </div> <h3 id="target-transformation-approach">Target Transformation Approach</h3> <p>The disadvantage of the previous technique is that models have their own errors and after subtracting their predictions we are not guaranteed that those errors cancel each other. Most likely the treatment effect has even bigger error. To avoid it we introduce an approach which models <strong>CATE</strong> explicitly. Let’s first describe it in the case of the binary outcome followed by the general case.</p> <h4 id="binary-target-jaskowski-m--jaroszewicz-s-uplift-modeling-for-clinical-trial-data-icml-workshop-on-clinical-data-analysis-vol-46-2012">Binary Target <d-footnote>Jaskowski M., &amp; Jaroszewicz S., "Uplift modeling for clinical trial data." ICML Workshop on Clinical Data Analysis. Vol. 46. 2012</d-footnote> </h4> <p><strong>CATE</strong> for the discrete target variable is defined in the following way</p> \[CATE = P(Y=1|X;W=1)-P(Y=1|X;W=0)\] <p>So it’s simply a probability of success in the treatment group minus the probability of success in the control group. Now introduce a new variable <strong>Z</strong></p> \[Z=Y\cdot W+(1-Y)\cdot (1-W).\] <p>Here is the list of all possible values of <strong>Z</strong>:</p> \[Z = \begin{cases} 1 &amp;\text{Y=1, $W=1 $}\\ 1 &amp;\text{Y=0, $W=0 $}\\ 0 &amp;\text{Y=0, $W=1 $}\\ 0 &amp;\text{Y=1, $W=0 $}\\ \end{cases}\] <p>Let’s compute the conditional probability of <strong>Z</strong> being 1.</p> \[P(Z=1|X)=P(Y=1|X;W=1)P(W=1|X)+P(Y=1|X;W=0)P(W=0|X)\] <p>Now we make an assumption of balanced treatment (whether an object is treated or not does not depend on $X$ and the probability of being treated is the same as the one of not being treated)</p> \[P(W=1|X)=P(W=0|X)=1/2\] <p>which simplifies the latter equation further and gives</p> \[P(Y=1|X;W=1)-P(Y=1|X;W=0)=2P(Z=1|X)-1\] <p>where left hand side is the definition of <strong>CATE</strong>. Therefore, modeling variable <strong>Z</strong> is the same as modeling uplift explicitly.</p> <h4 id="general-case-s-athey-and-g-w-imbens-machine-learning-methods-for-estimating-heterogeneous-causal-effects-stat-10505-2015b">General Case <d-footnote>S. Athey and G. W. Imbens, Machine learning methods for estimating heterogeneous causal effects, stat, 1050:5, 2015b.</d-footnote> </h4> <p>In the previous section we made assumption of balanced treatment, meaning equal treatment and control groups, which, in general, doesn’t hold in practice. Also $W$ being independent of $X$ can’t be achieved unless we have completely randomized process. To drop that assumption consider another transformation of the outcome variable which does not have to be binary anymore.</p> \[Z=Y(W=1)\cdot \frac{W}{p(X)}-Y(W=0)\cdot \frac{1-W}{1-p(X)}\] <p>where</p> \[p(X)=P(W=1|X)\] <p>is a propensity score (this idea is similar to the inverse propensity weighting approach). Let’s compute the expectation value of <strong>Z</strong> as we did in the previous section.</p> \[E[Z|X]=\frac{E[Y(W=1)\cdot W|X]}{p(X)}-\frac{E[Y(W=0)\cdot (1-W)]}{1-p(X)}\] <p>Conditional Independence Assumption or Unconfoundedness (whether object is treated or not does not depend on the outcome)</p> \[W \perp (Y(W=1), Y(W=0))|X\] <p>reduces the equation to the definition of <strong>CATE</strong></p> \[E[Z|X]=E[Y(W=1)|X]-E[Y(W=0)|X].\] <p>Here we used the following relationship</p> \[E[W|X]=p(X).\] <p>Again, modeling <strong>Z</strong> gives the treatment effect directly.</p> <h2 id="summary">Summary</h2> <p>As we discussed in the introduction it is important to incorporate treatments in the modeling process otherwise we would make wrong decisions. This was the motivation for reviewing four different approaches for modeling the treatment effect. I think it is natural to group them into two different groups.</p> <table> <thead> <tr> <th>Uplift Estimation</th> <th>Uplift Prediction</th> </tr> </thead> <tbody> <tr> <td> <strong>DiD</strong> Estimator</td> <td> <strong>2-Model</strong> Approach</td> </tr> <tr> <td><strong>Synthetic Control</strong></td> <td> <strong>Targete Transformation</strong> Method</td> </tr> </tbody> </table> <p><strong>DiD</strong> and <strong>Synthetic Control</strong> are used when intervention already occurred, post-intervention values of the treatment group are already observed and we want to estimate the effect. But if we want to predict the uplift before the intervention <strong>2-Model</strong> and <strong>Target Transformation</strong> approaches are relevant. And lastly, <strong>Synthetic Control</strong> is the only method out of these four which allows using time series of completely different variables than the one in the treatment group as a control and additionally, unlike <strong>DiD</strong>, it allows using a dissimilar time series of the same variable as a control.</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Andro Sabashvili </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-W9XQ8F3V19"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-W9XQ8F3V19");</script> </body> </html>